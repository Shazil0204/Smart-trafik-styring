@using System.ComponentModel.DataAnnotations
@using SmartTraficControlSystem.Components.Services
@using SmartTraficControlSystem.Utilities.Models
@inject AccountService AccountService

<MudForm @ref="form" @bind-IsValid="success" @bind-Errors="errors" Class="w-100">
    <MudTextField T="string" Label="User name" For="@(() => account.Username)" Required="true"
        InputType="InputType.Text" RequiredError="User name is required." Class="mb-3" />

    <MudTextField T="string" Label="Password" For="@(() => account.Password)" InputType="InputType.Password"
        Required="true" RequiredError="Password is required." Class="mb-4" />

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="w-100 mb-2" OnClick="Login">
        Login
    </MudButton>

    <MudText Class="mt-2 text-center">
        Don't have an account?
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Class="ml-1" OnClick="Register">
            Register
        </MudButton>
    </MudText>
</MudForm>


@code {
    [Parameter] public EventCallback<bool> HasAccount { get; set; }
    [Parameter] public EventCallback OnLoginSuccess { get; set; }

    private AccountModel account = new AccountModel()
    {
        Username = string.Empty,
        Password = string.Empty
    };
    private MudForm form;
    private bool success;
    private string[] errors = Array.Empty<string>();


    private async Task Login()
    {
        await form.Validate();
        if (!success)
            return;

        var loginSuccess = await AccountService.LoginAsync(account);
        if (loginSuccess)
        {
            await OnLoginSuccess.InvokeAsync();
        }
        else
        {
            errors = new[] { "Invalid username or password." };
        }
    }

    private async Task Register()
    {
        await HasAccount.InvokeAsync(false);
    }
}