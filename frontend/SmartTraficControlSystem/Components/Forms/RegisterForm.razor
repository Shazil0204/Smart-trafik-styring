@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using SmartTraficControlSystem.Components.Services
@using SmartTraficControlSystem.Utilities.Models
@inject AccountService AccountService
<MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors" Class="w-100">
    <MudTextField @bind-Value="account.Username" T="string" Label="User name" Required="true" InputType="InputType.Text"
        RequiredError="User name is required." OnlyValidateIfDirty Clearable Class="mb-3" />

    <MudTextField @bind-Value="account.Password" T="string" Label="Password" InputType="InputType.Password" Required="true"
        RequiredError="Password is required." OnlyValidateIfDirty Clearable Class="mb-3" />

    <MudTextField @bind-Value="confirmPassword" T="string" Label="Confirm Password" InputType="InputType.Password" Required="true"
        RequiredError="Please confirm your password." Validation="@ConfirmPasswordValidation" OnlyValidateIfDirty
        Clearable Class="mb-4" />

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="w-100 mb-2" OnClick="@(Submit)" Disabled="@isSubmitting">
        @if (isSubmitting)
        {
            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
            <MudText Class="ms-2">Registering...</MudText>
        }
        else
        {
            <MudText>Register</MudText>
        }
    </MudButton>

    <MudText Class="mt-2 text-center">
        Already have an account?
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Class="ml-1" OnClick="@GoToAccount">
            Login
        </MudButton>
    </MudText>
</MudForm>

@code {
    [Parameter] public EventCallback<bool> HasAccount { get; set; }
    [Parameter] public EventCallback OnRegisterRequested { get; set; }
    
    private AccountModel account = new AccountModel(){
        Username = string.Empty,
        Password = string.Empty
    };
    
    private string confirmPassword = string.Empty;
    private bool success;
    private bool isSubmitting = false;
    MudForm form;
    string[] errors = { };


    private async Task GoToAccount()
    {
        await HasAccount.InvokeAsync(true);
    }

    private string ConfirmPasswordValidation(string? confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "Please confirm your password.";

        if (confirmPassword != account.Password)
            return "Passwords do not match.";

        var regex = new Regex(@"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$");
        return regex.IsMatch(confirmPassword)
        ? null
        : "Password must be at least 8 characters and include uppercase, lowercase, number, and special character.";
    }
    
    private async Task Submit()
    {
        try 
        {
            isSubmitting = true;
            StateHasChanged(); // Force UI update
            
            await form.Validate();

            if (form.IsValid)
            {
                var success = await AccountService.RegisterAsync(account);
                if (success)
                {
                    await OnRegisterRequested.InvokeAsync();
                    // Handle successful registration (e.g., show a success message, redirect, etc.)
                }
                else
                {
                    // Handle failed registration (e.g., show an error message)
                    errors = new[] { "Registration failed. Please try again." };
                }
            }
        }
        catch (HttpRequestException ex)
        {
            errors = new[] { "Network error. Please check your connection and try again." };
        }
        catch (TaskCanceledException ex)
        {
            errors = new[] { "Request timed out. Please try again." };
        }
        catch (Exception ex)
        {
            errors = new[] { "An unexpected error occurred. Please try again." };
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged(); // Force UI update
        }
    }




}